<div class="container mt-4 p-4 border shadow-sm bg-light rounded">
    <div id="messageArea" class="mb-3"></div>
    <style>
        .card-header {
            background-color: #5C5CFF;
            color: white;
            border-radius: 12px 12px 0 0;
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
        }

        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .select2-container .select2-selection--single {
            height: 38px !important;
            padding: 6px 12px !important;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background-color: #fff;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
            box-shadow: none;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px !important;
            color: #495057;
            font-weight: 500;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
            right: 10px;
        }

        .select2-container--default .select2-selection--single:hover {
            border-color: #86b7fe;
        }

        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .select2-dropdown {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .select2-search--dropdown .select2-search__field {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            padding: 6px 12px;
        }

        .select2-container {
            width: 100%;
        }
    </style>
    <h1 class="card-header">Create Challan</h1>
    <br />
    <!-- Step 1: Roll Number Input -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label>Batch</label>
            <select id="batch" class="form-control" required>
                <option disabled selected>Select Batch</option>
                @if (ViewBag.BatchList != null && ViewBag.BatchList.Rows.Count > 0)
                {
                    foreach (System.Data.DataRow row in ViewBag.BatchList.Rows)
                    {
                        <option value="@row["SemesterSession"]">@row["SemesterSession"]</option>
                    }
                }
                else
                {
                    <option disabled>No batches found</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>Degree</label>
            <select id="dept" class="form-control" required>
                <option disabled selected>Select Degree</option>
                @if (ViewBag.DegreeList != null && ViewBag.DegreeList.Rows.Count > 0)
                {
                    foreach (System.Data.DataRow row in ViewBag.DegreeList.Rows)
                    {
                        <option value="@row["DegreeName"]">@row["DegreeName"]</option>
                    }
                }
                else
                {
                    <option disabled>No degrees found</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>Sequence No</label>
            <input type="text" id="seq" class="form-control" placeholder="e.g. 001" required />
        </div>
        <div class="col-md-3 mt-4">
            <button class="btn btn-primary mt-2" onclick="verifyRollNo()" style="background-color: #5C5CFF; ">Next</button>

        </div>
    </div>

    <!-- Step 2: Display Full Roll No & Student -->
    <div id="verifyResult" class="border p-3 mt-3 bg-white rounded d-none">
        <p><strong>Roll No : </strong> <span id="fullRoll"></span></p>
        <p><strong>Student Name : </strong> <span id="studentName"></span></p>
        <p><strong>Class Section : </strong> <span id="classSection"></span></p>
        <hr />


        <div class="form-group">
            <label>Semester Session</label>
            <select id="semesterSession" name="semesterSession" class="form-control" required>
                <option disabled selected>Select Semester Session</option>
                @if (ViewBag.SemesterList != null && ViewBag.SemesterList.Rows.Count > 0)
                {
                    foreach (System.Data.DataRow row in ViewBag.SemesterList.Rows)
                    {
                        <option value="@row["SemesterSession"]">@row["SemesterSession"]</option>
                    }
                }
                else
                {
                    <option disabled>No semester sessions found</option>
                }
            </select>
        </div>



        <div class="form-group">
            <label>Challan Type</label>
            <select id="challantype" name="challantype" class="form-control" required>
                <option disabled selected>Select Challan Type</option>
                @if (ViewBag.ChallanTypeList != null && ViewBag.ChallanTypeList.Rows.Count > 0)
                {
                    var manualTypes = new List<string> {
                        "FINE-Edit Challan", "Re App. Processing", "App. Processing", "UMC",
                        "Extension", "Non Attestation Fine", "Cancelled", "Igrade-FinalTerm",
                        "Igrade-MidTerm", "Fee Refund", "Testing", "Additional", "NUll"
                    };

                    foreach (System.Data.DataRow row in ViewBag.ChallanTypeList.Rows)
                    {
                        string type = row["ChallanType"].ToString();
                        if (manualTypes.Contains(type))
                        {
                            <option value="@type">@type</option>
                        }
                    }
                }
                else
                {
                    <option disabled>No Challan Types Available</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label>Amount</label>
            <input type="number" id="amount" class="form-control" placeholder="e.g. 5000" required />
        </div>

        <div class="form-group">
            <label>Issue Date</label>
            <input type="date" id="issueDate" class="form-control" required />
        </div>

        <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="dueDate" class="form-control" required />
        </div>
        <input type="hidden" id="studentID" />

        <button class="btn btn-success mt-3" onclick="createChallan()" style="background-color: #5C5CFF; ">Create Challan</button>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function verifyRollNo() {
        let batch = document.getElementById("batch").value.trim();
        let dept = document.getElementById("dept").value.trim();
        let seq = document.getElementById("seq").value.trim();

        if (!batch || !dept || !seq) {
            Swal.fire({
                title: "Missing Fields",
                text: "Please fill all roll number fields (Batch, Department, Sequence).",
                icon: "warning"
            });
            return;
        }

        let full = `${batch}/${dept}/${seq}`;

        fetch(`/CustomChallan/VerifyStudent?rollno=${full}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("verifyResult").classList.remove("d-none");
                    document.getElementById("fullRoll").innerText = full;
                    document.getElementById("studentName").innerText = data.name;
                    document.getElementById("classSection").innerText = data.section;
                    document.getElementById("studentID").value = data.id;
                } else {
                    Swal.fire({
                        title: "❌ Not Found",
                        text: "Student record not found.",
                        icon: "error"
                    });
                }
            });
    }

    function createChallan() {
        const btn = document.querySelector("button.btn-success");
        btn.disabled = true;

        const studentID = document.getElementById("studentID").value;
        const challanType = document.getElementById("challantype").value;
        const amount = document.getElementById("amount").value;
        const issueDate = document.getElementById("issueDate").value;
        const dueDate = document.getElementById("dueDate").value;
        const semesterSession = document.getElementById("semesterSession").value;

        if (!studentID || !challanType || !amount || !issueDate || !dueDate || !semesterSession) {
            Swal.fire({
                title: "⚠️ Missing Data",
                text: "Please fill all required fields before creating challan.",
                icon: "warning"
            });
            btn.disabled = false;
            return;
        }

        const payload = {
            StdRollNoID: studentID,
            ChallanTypeID: challanType,
            Amount: amount,
            IssueDate: issueDate,
            DueDate: dueDate,
            SemesterSession: semesterSession
        };

        fetch('/CustomChallan/CreateChallan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "✅ Success",
                        text: "Challan created successfully!",
                        icon: "success",
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire({
                        title: "❌ Failed",
                        text: data.message,
                        icon: "error"
                    });
                    btn.disabled = false;
                }
            })
            .catch(() => {
                Swal.fire({
                    title: "❌ Error",
                    text: "Something went wrong while saving challan!",
                    icon: "error"
                });
                btn.disabled = false;
            });
    }
</script>


<script>
    $(document).ready(function () {
        $('#semesterSession').select2({
            placeholder: "Select Semester Session",
            minimumResultsForSearch: 0,
            width: '100%'
        });
        $('#batch').select2({
            placeholder: "Select Batch",
            minimumResultsForSearch: 0,
            width: '100%'
        });
        $('#dept').select2({
            placeholder: "Select Degree",
            minimumResultsForSearch: 0,
            width: '100%'
        });
        $('#challantype').select2({
            placeholder: "Select Challan Type",
            minimumResultsForSearch: 0,
            width: '100%'
        });
    });
</script>
